<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
 <meta name="apple-mobile-web-app-capable" content="yes"/>
 <meta name="mobile-web-app-capable" content="yes"/>
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
 <meta name="format-detection" content="telephone=no"/>
  <meta name="color-scheme" content="dark"/>
  <meta name="theme-color" content="#050812"/>
  <title>Elite English Pro ¬∑ Premium Definitive v3</title>

  <!-- Premium single-file web app UI (no external dependencies) -->
  <style>
    :root{
      --bg:#050812;
      --bg2:#0a0f2a;
      --card:#12183a;
      --card2:#0b0f2e;
      --glass:#ffffff12;
      --stroke:#ffffff14;
      --text:#f4f6ff;
      --muted:#aab3d9;
      --brand:#7b7cff;
      --brand2:#35e3ff;
      --gold:#ffd479;
      --ok:#2bff88;
      --bad:#ff5a5a;
      --shadow:0 40px 120px rgba(0,0,0,.65);
      --shadow2:0 18px 60px rgba(0,0,0,.45);
      --radius:28px;
      --radius2:18px;
      --radius3:14px;
      --focus:0 0 0 4px rgba(53,227,255,.20);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 50% -280px,#1c2570,var(--bg)),
        radial-gradient(900px 600px at -20% 40%, rgba(53,227,255,.10), transparent 60%),
        radial-gradient(900px 600px at 120% 55%, rgba(123,124,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      padding-bottom: calc(120px + env(safe-area-inset-bottom));
      overflow-x:hidden;
    }

    /* Top App Bar */
    header{
      padding: calc(14px + env(safe-area-inset-top)) 18px 14px;
      background:#050812dd;
      backdrop-filter: blur(24px);
      position:sticky;
      top:0;
      z-index:60;
      border-bottom:1px solid var(--stroke);
    }
    .appbar{
      max-width:1060px;
      margin:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      user-select:none;
    }
    .logo{
      width:38px;height:38px;
      border-radius:14px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 16px 40px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute;inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
      transform: rotate(18deg);
    }
    .brand h1{
      margin:0;
      font-size:.95rem;
      letter-spacing:.14em;
      font-weight:950;
    }
    .brand small{display:block;color:var(--muted);font-weight:800;letter-spacing:.04em;margin-top:2px}

    .statusbar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:var(--glass);
      border:1px solid var(--stroke);
      color:#cfe2ff;
      font-weight:900;
      font-size:.78rem;
      letter-spacing:.02em;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--ok);box-shadow:0 0 0 4px rgba(43,255,136,.14)}
    .dot.off{background:var(--bad);box-shadow:0 0 0 4px rgba(255,90,90,.14)}

    .container{max-width:1060px;margin:auto;padding:22px}

    /* Cards */
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border-radius:var(--radius);
      padding:24px;
      margin-bottom:22px;
      box-shadow:var(--shadow);
      border:1px solid var(--stroke);
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(900px 500px at 10% 20%, rgba(53,227,255,.10), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(123,124,255,.10), transparent 60%);
      z-index:-1;
      opacity:.9;
    }

    .badge{
      font-size:.72rem;
      font-weight:950;
      letter-spacing:.14em;
      color:#bcd1ff;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge small{color:#9fb1ff;font-weight:850;letter-spacing:.06em;opacity:.95}

    .title-en{
      font-weight:950;
      font-size:1.55rem;
      line-height:1.25;
      margin:0;
      overflow-wrap:anywhere;
    }
    .text-es{color:var(--muted);margin-top:10px;line-height:1.5;overflow-wrap:anywhere}
    .text-fig{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color:var(--gold);
      background:#0008;
      padding:12px 14px;
      border-radius:var(--radius3);
      margin-top:12px;
      border:1px solid #ffffff12;
      overflow-wrap:anywhere;
    }

    .controls{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;align-items:center}

    .btn-icon{
      width:48px;height:48px;border-radius:50%;border:none;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;cursor:pointer;
      transition:transform .15s, filter .15s, box-shadow .15s;
      display:inline-flex;align-items:center;justify-content:center;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .btn-icon:hover{transform:scale(1.08);filter:brightness(1.05);box-shadow:0 16px 42px rgba(0,0,0,.42)}
    .btn-icon:active{transform:scale(0.98)}

    .btn-main{
      width:100%;padding:16px;border:none;border-radius:22px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      font-weight:950;color:#fff;margin-top:16px;cursor:pointer;
      transition:transform .15s, filter .15s;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      letter-spacing:.03em;
    }
    .btn-main:hover{transform:scale(1.02);filter:brightness(1.04)}
    .btn-main:active{transform:scale(0.99)}

    .btn-ghost{
      width:100%;padding:14px;border:1px solid #ffffff22;border-radius:18px;
      background:#ffffff0f;color:#fff;margin-top:10px;cursor:pointer;
      transition:background .15s, transform .15s;
      font-weight:900;
    }
    .btn-ghost:hover{background:#ffffff16;transform:translateY(-1px)}
    .btn-ghost:active{transform:translateY(0)}

    .tab{display:none; animation:fade .18s ease-out}
    .tab.active{display:block}
    @keyframes fade{from{opacity:.4;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    .option{
      background:#ffffff12;padding:14px;border-radius:14px;margin-top:10px;
      cursor:pointer;transition:background .15s, transform .10s, border-color .15s;
      border:1px solid transparent;user-select:none;
    }
    .option:hover{background:#ffffff18;transform:translateY(-1px)}
    .option.correct{background:#2bff8828;border-color:#2bff8870}
    .option.wrong{background:#ff5a5a24;border-color:#ff5a5a70}

    nav{
  position:fixed;left:0;right:0;bottom:0;
  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  background: linear-gradient(180deg, #050812f2, #050812fa);
  backdrop-filter: blur(32px) saturate(140%);
  z-index:70;border-top:1px solid var(--stroke);
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;
  align-items:center;
}
nav button{
  all:unset;cursor:pointer;
  width:100%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:6px;font-size:.66rem;font-weight:950;color:#9aa3d0;
  transition:transform .15s, color .15s, background .15s, box-shadow .15s, border-color .15s;
  user-select:none;
  padding:12px 10px;border-radius:18px;
  border:1px solid transparent;
}
nav button:hover{background:#ffffff12;transform:translateY(-2px)}
nav button:active{transform:translateY(0)}
nav button:focus-visible{box-shadow:var(--focus)}
nav button .ico{font-size:1.35rem;line-height:1}
nav button.active{
  color:var(--text);
  transform:translateY(-3px);
  background:linear-gradient(135deg, rgba(123,124,255,.34), rgba(53,227,255,.26));
  border-color:rgba(53,227,255,.35);
  box-shadow:0 18px 55px rgba(0,0,0,.48);
}
@media (min-width: 560px){
  nav{display:flex;justify-content:space-around;align-items:center;gap:0;}
  nav button{width:auto;flex:1 1 0;min-width:78px;padding:12px 12px;}
}
@media (max-width: 380px){
  nav{gap:8px;padding:10px 10px calc(10px + env(safe-area-inset-bottom));}
  nav button{padding:10px 8px;font-size:.62rem}
  nav button .ico{font-size:1.25rem}
}

    input,select,textarea{
      width:100%;border:none;border-radius:14px;padding:14px;
      background:#0007;color:#fff;font-size:1rem;outline:none;
      border:1px solid var(--stroke);
      transition:box-shadow .12s, border-color .12s;
    }
    input:focus,select:focus,textarea:focus{box-shadow:var(--focus); border-color:rgba(53,227,255,.40)}
    textarea{min-height:128px;resize:none}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    .small{font-size:.92rem;color:var(--muted);line-height:1.35}
    .divider{height:1px;background:#ffffff12;margin:16px 0}

    .pill{
      display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;
      background:var(--glass);color:#cfe2ff;font-weight:950;font-size:.78rem;
      margin-top:10px;border:1px solid var(--stroke);
    }

    .toast{
      position:fixed;left:50%;bottom:108px;transform:translateX(-50%);
      background:#0b0f2ee6;border:1px solid #ffffff18;border-radius:16px;
      padding:12px 14px;min-width:260px;max-width:min(620px, calc(100vw - 30px));
      box-shadow:0 20px 70px rgba(0,0,0,.45);
      display:none;z-index:100;backdrop-filter: blur(18px);
    }
    .toast.show{display:block;animation:pop .16s ease-out}
    @keyframes pop{from{transform:translateX(-50%) translateY(10px);opacity:.6}to{transform:translateX(-50%) translateY(0);opacity:1}}
    .toast .t-title{font-weight:950;letter-spacing:.02em}
    .toast .t-body{color:var(--muted);margin-top:4px;font-size:.92rem}

    .svg{width:20px;height:20px;display:block}

    /* Translator grid */
    .translator-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 860px){
      .translator-grid{grid-template-columns:1fr auto 1fr;align-items:stretch}
    }
    .swap{
      display:flex;flex-direction:column;gap:10px;justify-content:center
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:.78rem;
      padding:4px 8px;
      border-radius:10px;
      background:#0008;
      border:1px solid #ffffff12;
      color:#cfe2ff;
      display:inline-block;
    }
  
/* ===== Premium app polish (final) ===== */
header{display:none !important;}
.container{padding-top:12px;}
:root{--navH: 168px;}
body{padding-bottom: calc(var(--navH) + 22px + env(safe-area-inset-bottom));}
@media (min-width: 560px){:root{--navH: 98px;} body{padding-bottom: calc(var(--navH) + 20px + env(safe-area-inset-bottom));}}


/* ===== Mobile bottom nav compact (v6) ===== */
@media (max-width: 520px){
  nav{gap:8px; padding:8px 10px calc(8px + env(safe-area-inset-bottom));}
  nav button{padding:10px 8px; gap:5px; border-radius:16px; font-size:.60rem;}
  nav button .ico{font-size:1.18rem;}
}
@media (max-width: 380px){
  nav{gap:7px; padding:7px 8px calc(7px + env(safe-area-inset-bottom));}
  nav button{padding:9px 7px; font-size:.58rem;}
  nav button .ico{font-size:1.12rem;}
}

/* ===== Premium forms & layout fixes ===== */
input, select, textarea{max-width:100%;font-size:16px;}
textarea{min-height:170px;line-height:1.45;}
#tab-translator textarea{background: linear-gradient(180deg, rgba(0,0,0,.50), rgba(0,0,0,.28));border-color: rgba(255,255,255,.16);}
#tab-translator textarea:focus{border-color: rgba(53,227,255,.55)}
#tab-translator .translator-grid{gap:16px}
#tab-translator .controls{justify-content:flex-start}
#tab-translator .swap{align-items:center}
#tab-translator .swap .pill{width:100%;justify-content:center}

#tab-speak .row{gap:12px}
#tab-speak input{width:100%}
#spResult{background:#ffffff0a;border:1px solid #ffffff12;border-radius:16px;padding:12px 14px;min-height:52px}

#tab-global .row{align-items:flex-end}
#tab-global input, #tab-global select{width:100%}

@media (max-width: 520px){
  .row{flex-direction:column;}
  .row > *{flex:1 1 auto;}
  #tab-translator .swap{display:none;}
  textarea{min-height:190px;}
}

</style>
</head>

<body>
<header>
  <div class="appbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>ELITE ENGLISH PRO</h1>
        <small>Premium Web App ¬∑ Offline-first</small>
      </div>
    </div>
    <div class="statusbar">
      <div class="chip" id="chipNet"><span class="dot" id="dotNet"></span><span id="netTxt">Online</span></div>
      <div class="chip" id="chipAI"><span class="dot off" id="dotAI"></span><span id="aiTxt">AI: OFF</span></div>
    </div>
  </div>
</header>

<div class="container">

  <!-- PHRASES -->
  <section id="tab-phrases" class="tab active">
    <div class="card">
      <div class="badge"><span>PHRASES</span><small id="ph-meta">Unlimited ¬∑ Smart fallback</small></div>
      <p id="phEn" class="title-en"></p>
      <div id="phFig" class="text-fig"></div>
      <div id="phEs" class="text-es"></div>
      <div class="controls">
        <button class="btn-icon" id="phPlay" title="Play EN">
          <svg class="svg" viewBox="0 0 24 24" fill="none"><path d="M9 7v10l9-5-9-5Z" fill="white"/></svg>
        </button>
        <button class="btn-icon" id="phSlow" title="Slow EN">
          <svg class="svg" viewBox="0 0 24 24" fill="none"><path d="M12 6v6l4 2" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M12 21a9 9 0 1 0-9-9" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button class="btn-icon" id="phDuo" title="EN then ES">
          <svg class="svg" viewBox="0 0 24 24" fill="none"><path d="M3 5h18v14H3V5Z" stroke="white" stroke-width="2"/><path d="M7 9h4M7 13h6" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M14 9h3M14 13h3" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <button class="btn-main" id="phNew">NEW PHRASE</button>
      <div class="pill" id="phStatus" style="display:none"></div>
      <p class="small">Tip: atajos ‚Äî <span class="kbd">P</span> nueva frase ¬∑ <span class="kbd">T</span> traductor</p>
    </div>
  </section>

  <!-- STORIES -->
  <section id="tab-stories" class="tab">
    <div class="card">
      <div class="badge"><span>STORIES</span><small id="st-meta">Wikipedia random summary</small></div>
      <p id="stTitle" class="title-en"></p>
      <div id="stEn" class="text-es" style="margin-top:10px;color:#e9edff"></div>
      <div id="stFig" class="text-fig"></div>
      <div id="stEs" class="text-es"></div>
      <div class="controls">
        <button class="btn-icon" id="stPlay" title="Play EN">
          <svg class="svg" viewBox="0 0 24 24" fill="none"><path d="M9 7v10l9-5-9-5Z" fill="white"/></svg>
        </button>
        <button class="btn-icon" id="stSlow" title="Slow EN">
          <svg class="svg" viewBox="0 0 24 24" fill="none"><path d="M12 6v6l4 2" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M12 21a9 9 0 1 0-9-9" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button class="btn-icon" id="stDuo" title="EN then ES">
          <svg class="svg" viewBox="0 0 24 24" fill="none"><path d="M3 5h18v14H3V5Z" stroke="white" stroke-width="2"/><path d="M7 9h4M7 13h6" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M14 9h3M14 13h3" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <button class="btn-main" id="stNew">NEW STORY</button>
      <div class="pill" id="stStatus" style="display:none"></div>
      <p class="small">Si Wikipedia falla (sin internet), se usa un generador local ilimitado.</p>
    </div>
  </section>

  <!-- SPEAK -->
  <section id="tab-speak" class="tab">
    <div class="card">
      <div class="badge"><span>SPEAK</span><small id="sp-meta">Unlimited ¬∑ Custom phrase enabled</small></div>

      <p id="spTarget" class="title-en"></p>
      <div id="spFig" class="text-fig"></div>
      <div id="spEs" class="text-es"></div>

      <div class="controls">
        <button class="btn-icon" id="spPlay" title="Play EN">
          <svg class="svg" viewBox="0 0 24 24" fill="none"><path d="M9 7v10l9-5-9-5Z" fill="white"/></svg>
        </button>
        <button class="btn-icon" id="spMic" title="Mic">
          <svg class="svg" viewBox="0 0 24 24" fill="none"><path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3Z" stroke="white" stroke-width="2"/><path d="M19 11a7 7 0 0 1-14 0" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M12 18v3" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div>
          <label class="small">‚úÖ Escribe tu propia frase para practicar (opcional):</label>
          <input id="spCustom" type="text" placeholder="Type your own English sentence..."/>
        </div>
        <div>
          <label class="small">&nbsp;</label>
          <button class="btn-ghost" id="spUseCustom">Use my phrase</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label class="small">Si no hay micr√≥fono, escribe lo que dijiste:</label>
          <input id="spManual" type="text" placeholder="I always practice English after work."/>
        </div>
        <div>
          <label class="small">&nbsp;</label>
          <button class="btn-ghost" id="spEvalManual">Evaluate typed speech</button>
        </div>
      </div>

      <div class="divider"></div>
      <div id="spResult" class="text-es"></div>

      <button class="btn-main" id="spNew">NEW PHRASE</button>
      <div class="pill" id="spStatus" style="display:none"></div>
      <p class="small">Tip: el micr√≥fono suele requerir HTTPS/localhost. En modo manual siempre funciona.</p>
    </div>
  </section>

  <!-- EXERCISES -->
  <section id="tab-exercises" class="tab">
    <div class="card">
      <div class="badge"><span>EXERCISES</span><small id="ex-meta">Unlimited ¬∑ Always new</small></div>
      <p id="exQ" class="title-en"></p>
      <div id="exOpts"></div>
      <button class="btn-main" id="exNew">NEW EXERCISE</button>
      <div class="pill" id="exStatus" style="display:none"></div>
      <p class="small">Siempre genera ejercicios nuevos. Si no hay internet, usa generador local ilimitado.</p>
    </div>
  </section>

  <!-- TRANSLATOR -->
  <section id="tab-translator" class="tab">
    <div class="card">
      <div class="badge"><span>TRANSLATOR</span><small id="tr-meta">ES ‚áÑ EN ¬∑ Online + Offline</small></div>

      <div class="row" style="margin-bottom:10px">
        <div>
          <label class="small">Modo</label>
          <select id="trMode">
            <option value="auto">AUTO (detect)</option>
            <option value="en-es">EN ‚Üí ES</option>
            <option value="es-en">ES ‚Üí EN</option>
          </select>
        </div>
        <div>
          <label class="small">Acciones r√°pidas</label>
          <button class="btn-ghost" id="trSwap">Swap</button>
        </div>
      </div>

      <div class="translator-grid">
        <div>
          <label class="small">Texto</label>
          <textarea id="trIn" placeholder="Escribe aqu√≠ (English o Espa√±ol)..."></textarea>
          <div class="controls">
            <button class="btn-icon" id="trSpeakIn" title="TTS input">üîä</button>
            <button class="btn-icon" id="trCopyIn" title="Copy input">üìã</button>
            <button class="btn-icon" id="trClear" title="Clear">‚úñ</button>
          </div>
        </div>

        <div class="swap" aria-hidden="true">
          <div class="pill">Atajos</div>
          <div class="small">Traducir: <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span></div>
          <div class="small">Swap: <span class="kbd">Alt</span>+<span class="kbd">S</span></div>
        </div>

        <div>
          <label class="small">Resultado</label>
          <textarea id="trOut" placeholder="Translation result..." readonly></textarea>
          <div class="controls">
            <button class="btn-icon" id="trSpeakOut" title="TTS output">üîä</button>
            <button class="btn-icon" id="trCopyOut" title="Copy output">üìã</button>
          </div>
        </div>
      </div>

      <button class="btn-main" id="trGo">TRANSLATE</button>
      <div class="pill" id="trStatus" style="display:none"></div>
      <p class="small">El traductor usa MyMemory cuando hay internet. Si falla, usa traducci√≥n offline aproximada. (Nunca se rompe.)</p>
    </div>
  </section>

  <!-- GLOBAL -->
  <section id="tab-global" class="tab">
    <div class="card">
      <div class="badge"><span>GLOBAL ¬∑ SETTINGS</span><small>Premium stable engine</small></div>
      <div class="row">
        <div>
          <label class="small">Gemini API Key (se guarda solo en tu navegador)</label>
          <input id="geminiKey" type="password" placeholder="Paste your Gemini API Key"/>
        </div>
        <div>
          <label class="small">AI Mode</label>
          <select id="aiMode">
            <option value="off">OFF (Robust fallback)</option>
            <option value="gemini">GEMINI (Optional)</option>
          </select>
        </div>
      </div>
      <button class="btn-main" id="saveGlobal">SAVE SETTINGS</button>
      <button class="btn-ghost" id="testGemini">Test Gemini</button>
      <div class="divider"></div>
      <div id="globalStatus" class="text-es"></div>
      <p class="small">Si Gemini no responde, el sistema seguir√° generando contenido ilimitado (internet + generador local).</p>
    </div>
  </section>

</div>

<nav id="bottomNav">
  <button class="active" data-tab="tab-phrases"><div class="ico">‚ö°</div><span>PHRASES</span></button>
  <button data-tab="tab-stories"><div class="ico">üìñ</div><span>STORIES</span></button>
  <button data-tab="tab-speak"><div class="ico">üéôÔ∏è</div><span>SPEAK</span></button>
  <button data-tab="tab-exercises"><div class="ico">üèãÔ∏è</div><span>EXERCISES</span></button>
  <button data-tab="tab-translator"><div class="ico">üåê</div><span>TRANSLATE</span></button>
  <button data-tab="tab-global"><div class="ico">‚öôÔ∏è</div><span>GLOBAL</span></button>
</nav>

<div class="toast" id="toast"><div class="t-title" id="toastTitle">Info</div><div class="t-body" id="toastBody"></div></div>

<script>
"use strict";

/* ===================== CORE HELPERS ===================== */
const $ = (id) => document.getElementById(id);
const rnd = (arr) => arr[Math.floor(Math.random()*arr.length)];
const sleep = (ms) => new Promise(r=>setTimeout(r,ms));

const UI = Object.freeze({
  tabs: () => Array.from(document.querySelectorAll(".tab")),
  navBtns: () => Array.from(document.querySelectorAll("nav button")),

  phEn: $("phEn"), phFig: $("phFig"), phEs: $("phEs"), phStatus: $("phStatus"), phMeta: $("ph-meta"),
  stTitle: $("stTitle"), stEn: $("stEn"), stFig: $("stFig"), stEs: $("stEs"), stStatus: $("stStatus"), stMeta: $("st-meta"),
  spTarget: $("spTarget"), spFig: $("spFig"), spEs: $("spEs"), spResult: $("spResult"), spStatus: $("spStatus"), spMeta: $("sp-meta"),
  spManual: $("spManual"), spCustom: $("spCustom"),
  exQ: $("exQ"), exOpts: $("exOpts"), exStatus: $("exStatus"), exMeta: $("ex-meta"),

  // Translator
  trMode: $("trMode"), trIn: $("trIn"), trOut: $("trOut"), trStatus: $("trStatus"), trMeta: $("tr-meta"),

  geminiKey: $("geminiKey"), aiMode: $("aiMode"), globalStatus: $("globalStatus"),

  chipNet: $("chipNet"), dotNet: $("dotNet"), netTxt: $("netTxt"),
  chipAI: $("chipAI"), dotAI: $("dotAI"), aiTxt: $("aiTxt"),

  toast: $("toast"), toastTitle: $("toastTitle"), toastBody: $("toastBody")
});

const STORE = Object.freeze({
  GEMINI_KEY: "EEP_GEMINI_KEY",
  AI_MODE: "EEP_AI_MODE"
});

function safeGet(key, fallback=""){
  try{ return localStorage.getItem(key) ?? fallback; }catch{ return fallback; }
}
function safeSet(key, value){
  try{ localStorage.setItem(key, value); }catch{}
}

let toastTimer = null;
function toast(title, body, ms=2300){
  UI.toastTitle.textContent = title;
  UI.toastBody.textContent = body;
  UI.toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>UI.toast.classList.remove("show"), ms);
}
function pill(el, text, ms=1200){
  el.textContent = text;
  el.style.display = "inline-flex";
  if(ms>0) setTimeout(()=> el.style.display = "none", ms);
}

/* ===================== STATUS CHIPS ===================== */
function updateNetChip(){
  const online = navigator.onLine;
  UI.netTxt.textContent = online ? "Online" : "Offline";
  UI.dotNet.classList.toggle("off", !online);
}
function updateAIChip(){
  const mode = UI.aiMode.value;
  const on = (mode === "gemini");
  UI.aiTxt.textContent = on ? "AI: GEMINI" : "AI: OFF";
  UI.dotAI.classList.toggle("off", !on);
}
window.addEventListener("online", updateNetChip);
window.addEventListener("offline", updateNetChip);

/* ===================== TABS ===================== */
function setTab(tabId){
  UI.tabs().forEach(t=>t.classList.remove("active"));
  $(tabId)?.classList.add("active");
  UI.navBtns().forEach(b=>b.classList.remove("active"));
  const activeBtn = document.querySelector(`nav button[data-tab="${tabId}"]`);
  activeBtn?.classList.add("active");
}
UI.navBtns().forEach(btn=> btn.addEventListener("click", ()=>setTab(btn.dataset.tab)));

/* ===================== AUDIO TTS ===================== */
function tts(text, lang="en", rate=1){
  if(!text) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = (lang==="en") ? "en-US" : "es-ES";
    u.rate = rate;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch{
    toast("Audio", "Tu navegador no soporta TTS.");
  }
}
async function duo(en, es){
  if(en) tts(en, "en", 1);
  await sleep(1100);
  if(es) tts(es, "es", 1);
}

/* ===================== FETCH WITH TIMEOUT ===================== */
async function fetchJson(url,{timeoutMs=7000,method="GET",headers={},body=null}={}){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, {method, headers, body, signal: controller.signal});
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } finally {
    clearTimeout(t);
  }
}

/* ===================== PHONETIC ENGINE ===================== */
function phoneticENtoES(text){
  if(!text) return "";
  let t = (" " + text.toLowerCase() + " ");
  const dict = {
    "the":"de","this":"dis","that":"dat","these":"d√≠is","those":"d√≥us",
    "think":"zink","thing":"zin","thought":"z√≥t",
    "through":"zr√∫","though":"d√≥u","there":"der","their":"der","they":"dei",
    "what":"u√°t","where":"u√©r","when":"u√©n","why":"u√°i",
    "would":"uud","could":"kud","should":"shud",
    "you":"i√∫","your":"i√≥r","yes":"y√©s",
    "one":"u√°n","two":"t√∫","three":"zr√≠",
    "enough":"in√°f","laugh":"l√°f",
    "people":"p√≠pol","very":"v√©ri",
    "work":"u√©rk","world":"u√©rld",
    "practice":"pr√°ctis","english":"√≠nglish"
  };
  for(const w in dict){
    t = t.replace(new RegExp(`\\b${w}\\b`, "g"), dict[w]);
  }

  t = t.replace(/th/g,"z")
       .replace(/sh/g,"sh")
       .replace(/ch/g,"ch")
       .replace(/ph/g,"f")
       .replace(/ck/g,"k")
       .replace(/gh\\b/g,"")
       .replace(/ng\\b/g,"ng")
       .replace(/ee/g,"ii")
       .replace(/ea/g,"√≠")
       .replace(/oo/g,"u")
       .replace(/ou/g,"au")
       .replace(/ow/g,"au")
       .replace(/igh/g,"√°i")
       .replace(/ai/g,"√©i")
       .replace(/ay/g,"√©i")
       .replace(/ie/g,"√°i")
       .replace(/oa/g,"√≥u")
       .replace(/tion\\b/g,"shon")
       .replace(/sion\\b/g,"shon")
       .replace(/ed\\b/g,"d")
       .replace(/ing\\b/g,"in")
       .replace(/ly\\b/g,"li")
       .replace(/er\\b/g,"er")
       .replace(/wr/g,"r")
       .replace(/h/g,"");

  return t.replace(/[^a-z√°√©√≠√≥√∫√±√º\s]/gi,"").replace(/\s+/g," ").trim();
}

/* ===================== TRANSLATION (ONLINE + OFFLINE, BIDIRECTIONAL) ===================== */
function clean(t){
  return (t ?? "").replace(/[*¬ß‚Ä¢]/g, "").replace(/\s+/g, " ").trim();
}
function educationalFallbackES(){
  return rnd([
    "Esta es una frase para practicar ingl√©s.",
    "Esta oraci√≥n sirve como ejemplo de aprendizaje.",
    "Practica esta frase en ingl√©s.",
    "Esta es una frase sencilla para estudiar ingl√©s."
  ]);
}
function educationalFallbackEN(){
  return rnd([
    "This is a sentence to practice English.",
    "This sentence is an example for learning.",
    "Practice this sentence in English.",
    "This is a simple sentence for study."
  ]);
}

const MINI_DICT_EN_ES = Object.freeze({
  "i":"yo","you":"t√∫","he":"√©l","she":"ella","we":"nosotros","they":"ellos",
  "always":"siempre","usually":"usualmente","often":"a menudo","sometimes":"a veces","never":"nunca",
  "practice":"practico","practices":"practica","study":"estudio","studies":"estudia",
  "work":"trabajo","works":"trabaja","go":"voy","goes":"va","eat":"como","eats":"come",
  "play":"juego","plays":"juega","read":"leo","reads":"lee","write":"escribo","writes":"escribe",
  "listen":"escucho","listens":"escucha","learn":"aprendo","learns":"aprende","speak":"hablo","speaks":"habla",
  "english":"ingl√©s","after":"despu√©s","before":"antes","school":"escuela","home":"casa",
  "morning":"ma√±ana","day":"d√≠a","every":"cada","with":"con","my":"mi","friends":"amigos",
  "at":"en","in":"en","to":"a","a":"un","the":"el","and":"y","is":"es","are":"son",
  "today":"hoy","yesterday":"ayer","weekend":"fin de semana"
});

// Build reverse dictionary (best effort). In collisions, keep first.
const MINI_DICT_ES_EN = (()=>{
  const rev = {};
  for(const [en, es] of Object.entries(MINI_DICT_EN_ES)){
    const key = String(es).toLowerCase();
    if(!rev[key]) rev[key] = en;
  }
  // add common spanish function words
  Object.assign(rev, {
    "hola":"hello",
    "buenos":"good",
    "buenas":"good",
    "gracias":"thanks",
    "por":"for",
    "favor":"please",
    "yo":"i",
    "t√∫":"you",
    "tu":"your",
    "√©l":"he",
    "el":"the",
    "ella":"she",
    "nosotros":"we",
    "ellos":"they",
    "en":"in",
    "con":"with",
    "cada":"every",
    "siempre":"always",
    "nunca":"never",
    "hoy":"today",
    "ayer":"yesterday"
  });
  return Object.freeze(rev);
})();

function offlineTranslateWordByWord(text, dir){
  // dir: 'en-es' or 'es-en'
  const t = clean(text);
  if(!t) return (dir === 'en-es') ? educationalFallbackES() : educationalFallbackEN();

  if(dir === 'en-es'){
    const words = t.toLowerCase().replace(/[^a-z\s']/g, "").split(/\s+/).filter(Boolean);
    if(!words.length) return educationalFallbackES();
    const out = words.map(w => MINI_DICT_EN_ES[w] ?? w);
    return "Traducci√≥n aproximada: " + out.join(" ") + ".";
  }else{
    // remove accents partially by keeping letters + accents; map by lowercase.
    const words = t.toLowerCase().replace(/[^a-z√°√©√≠√≥√∫√±√º\s]/g, "").split(/\s+/).filter(Boolean);
    if(!words.length) return educationalFallbackEN();
    const out = words.map(w => MINI_DICT_ES_EN[w] ?? w);
    return "Approx. translation: " + out.join(" ") + ".";
  }
}

async function translateMyMemory(text, dir){
  // dir: 'en-es' or 'es-en'
  const t = clean(text);
  if(!t) return "";
  const pair = dir === 'en-es' ? 'en|es' : 'es|en';
  const url = "https://api.mymemory.translated.net/get?q=" + encodeURIComponent(t) + "&langpair=" + pair;
  const data = await fetchJson(url, {timeoutMs: 7500});
  return clean(data?.responseData?.translatedText ?? "");
}

function detectLang(text){
  // Simple heuristic: Spanish if contains accented letters or many common Spanish words.
  const t = (text||"").toLowerCase();
  if(/[√°√©√≠√≥√∫√±√º]/.test(t)) return 'es';
  const esHits = [" el "," la "," de "," que "," y "," en "," por ","para ","hola","gracias","buenos"].reduce((a,w)=> a + (t.includes(w)?1:0), 0);
  const enHits = [" the "," and "," to "," of "," in "," for ","with ","hello","thanks"].reduce((a,w)=> a + (t.includes(w)?1:0), 0);
  return (esHits >= enHits) ? 'es' : 'en';
}

async function translate(text, mode){
  // mode: auto, en-es, es-en
  const t = clean(text);
  if(!t) return {out:"", used:"-"};

  let dir = mode;
  if(mode === 'auto'){
    dir = (detectLang(t) === 'es') ? 'es-en' : 'en-es';
  }

  // Online first (if possible)
  if(navigator.onLine){
    try{
      const out = await translateMyMemory(t, dir);
      if(out && out.length >= 2) return {out, used:"MyMemory"};
    }catch{}
  }

  // Offline fallback
  const off = offlineTranslateWordByWord(t, dir);
  return {out: off, used:"Offline"};
}

/* ===================== GEMINI (OPTIONAL) ===================== */
async function gemini(prompt){
  if(UI.aiMode.value !== "gemini") throw new Error("AI mode OFF");
  const key = UI.geminiKey.value.trim();
  if(!key) throw new Error("Missing Gemini key");

  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + encodeURIComponent(key);
  const body = JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] });

  const data = await fetchJson(endpoint, {
    method: "POST",
    timeoutMs: 9000,
    headers: {"Content-Type":"application/json"},
    body
  });

  const out = data?.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!out) throw new Error("Gemini empty");
  return String(out).trim();
}

/* ===================== UNLIMITED GENERATORS ===================== */
const GEN = Object.freeze({
  subjects: ["I","You","He","She","We","They"],
  adverbs: ["always","usually","often","sometimes","never"],
  verbs: [
    {b:"practice", s:"practices"},
    {b:"study", s:"studies"},
    {b:"work", s:"works"},
    {b:"read", s:"reads"},
    {b:"write", s:"writes"},
    {b:"listen", s:"listens"},
    {b:"learn", s:"learns"},
    {b:"speak", s:"speaks"},
    {b:"go", s:"goes"},
    {b:"cook", s:"cooks"},
    {b:"walk", s:"walks"}
  ],
  objects: [
    "English every day",
    "at school",
    "in the morning",
    "after work",
    "with my friends",
    "at home",
    "on the weekend",
    "before dinner",
    "at the park",
    "in my free time"
  ],
  extras: [
    "to improve my skills",
    "to feel more confident",
    "because it helps me",
    "to communicate better",
    "for my future",
    "to learn new words"
  ],
  storyStarts: ["Today,","Yesterday,","In the morning,","After work,","On the weekend,"],
  storyPeople: ["Tom","Ana","Luis","Sara","David","Maria"],
  storyPlaces: ["at home","at school","in the park","at work","in the city"],
  storyActions: ["practices English","studies new words","listens to a short story","speaks with a friend","reads a simple text"]
});

function buildSentence(){
  const s = rnd(GEN.subjects);
  const adv = rnd(GEN.adverbs);
  const v = rnd(GEN.verbs);
  const obj = rnd(GEN.objects);
  const extra = Math.random() < 0.55 ? (" " + rnd(GEN.extras)) : "";
  const verb = (s === "He" || s === "She") ? v.s : v.b;
  return `${s} ${adv} ${verb} ${obj}${extra}.`.replace(/\s+/g, " ").trim();
}

function buildSpeakSentence(){
  const s = rnd(["I","You","He","She","We","They"]);
  const v = rnd([{b:"practice",s:"practices"},{b:"study",s:"studies"},{b:"work",s:"works"},{b:"speak",s:"speaks"},{b:"read",s:"reads"}]);
  const obj = rnd(["English every day","at home","after work","in the morning","with friends"]);
  const verb = (s === "He" || s === "She") ? v.s : v.b;
  return `${s} ${verb} ${obj}.`;
}

function buildLocalStory(){
  const start = rnd(GEN.storyStarts);
  const name = rnd(GEN.storyPeople);
  const place = rnd(GEN.storyPlaces);
  const action1 = rnd(GEN.storyActions);
  const action2 = rnd(GEN.storyActions);
  const end = rnd(["He feels more confident.","She feels more confident.","They learn something new.","It becomes a good habit.","It helps a lot."]);
  const s1 = `${start} ${name} is ${place}.`;
  const s2 = `${name} ${action1}.`;
  const s3 = (action2 !== action1) ? `${name} also ${action2}.` : `${name} repeats the practice.`;
  return `${s1} ${s2} ${s3} ${end}`.replace(/\s+/g, " ").trim();
}

/* ===================== ONLINE SOURCES ===================== */
async function getOnlinePhrase(){
  const sources = [
    async()=> (await fetchJson("https://api.quotable.io/random", {timeoutMs: 6500}))?.content,
    async()=> (await fetchJson("https://api.adviceslip.com/advice", {timeoutMs: 6500}))?.slip?.advice,
    async()=> {
      const d = await fetchJson("https://baconipsum.com/api/?type=meat-and-filler&sentences=1", {timeoutMs: 6500});
      return Array.isArray(d) ? d[0] : null;
    }
  ];
  for(const s of sources){
    try{
      const t = clean(await s());
      if(t && t.length >= 6 && t.length <= 160) return t;
    }catch{}
  }
  return null;
}

async function getWikipediaStory(){
  const url = "https://en.wikipedia.org/api/rest_v1/page/random/summary";
  const d = await fetchJson(url, {timeoutMs: 8000});
  const title = clean(d?.title ?? "Wikipedia");
  const extract = clean(d?.extract ?? "");
  if(!extract || extract.length < 60) throw new Error("Wikipedia short");
  return { title, extract };
}

/* ===================== CACHES (AVOID REPEATS) ===================== */
const mem = {
  phrases: new Set(),
  speak: new Set(),
  exercises: new Set(),
  stories: new Set()
};
function cacheAdd(set, value, max=340){
  if(!value) return;
  set.add(value);
  if(set.size > max) set.clear();
}
function isRepeat(set, value){ return set.has(value); }

/* ===================== RENDER ===================== */
async function renderPhrase(en, meta){
  const text = clean(en).replace(/\s+/g, " ").trim();
  const safe = text.endsWith(".") ? text : (text + ".");
  UI.phEn.textContent = safe;
  UI.phFig.textContent = phoneticENtoES(safe);
  UI.phEs.textContent = (await translate(safe, 'en-es')).out;
  UI.phMeta.textContent = meta;
  pill(UI.phStatus, "‚úÖ Ready", 1100);
}

async function renderStory(title, en, meta){
  const safeTitle = clean(title) || "Wikipedia";
  const text = clean(en).replace(/\s+/g, " ").trim();
  UI.stTitle.textContent = safeTitle;
  UI.stEn.textContent = text;
  UI.stFig.textContent = phoneticENtoES(text);
  UI.stEs.textContent = (await translate(text, 'en-es')).out;
  UI.stMeta.textContent = meta;
  pill(UI.stStatus, "‚úÖ Ready", 1100);
}

async function renderSpeak(en, meta){
  const text = clean(en).replace(/\s+/g, " ").trim();
  const safe = text.endsWith(".") ? text : (text + ".");
  UI.spTarget.textContent = safe;
  UI.spFig.textContent = phoneticENtoES(safe);
  UI.spEs.textContent = (await translate(safe, 'en-es')).out;
  UI.spMeta.textContent = meta;
  UI.spResult.textContent = "";
  UI.spManual.value = "";
  pill(UI.spStatus, "‚úÖ Ready", 1100);
}

function renderExercise(question, options, correct, meta){
  UI.exQ.textContent = question;
  UI.exOpts.innerHTML = "";
  options.forEach(o=>{
    const d = document.createElement("div");
    d.className = "option";
    d.textContent = o;
    d.addEventListener("click", ()=> d.classList.add(o === correct ? "correct" : "wrong"));
    UI.exOpts.appendChild(d);
  });
  UI.exMeta.textContent = meta;
  pill(UI.exStatus, "‚úÖ Ready", 1100);
}

/* ===================== PIPELINES ===================== */
async function loadPhrase(){
  pill(UI.phStatus, "‚è≥ Loading...", 900);

  if(UI.aiMode.value === "gemini"){
    try{
      const g = await gemini(
        "Generate ONE short English sentence for language learning.\n"+
        "Rules: CEFR A1‚ÄìA2, no jokes, no irony, no advice, max 10 words, end with a period."
      );
      const text = clean(g);
      if(text && !isRepeat(mem.phrases, text)){
        cacheAdd(mem.phrases, text);
        return renderPhrase(text, "Gemini");
      }
    }catch{}
  }

  try{
    const online = await getOnlinePhrase();
    if(online && !isRepeat(mem.phrases, online)){
      cacheAdd(mem.phrases, online);
      return renderPhrase(online, "Internet");
    }
  }catch{}

  for(let i=0;i<6;i++){
    const local = buildSentence();
    if(local && !isRepeat(mem.phrases, local)){
      cacheAdd(mem.phrases, local);
      return renderPhrase(local, "Local generator");
    }
  }

  return renderPhrase(buildSentence(), "Local generator");
}

async function loadStory(){
  pill(UI.stStatus, "‚è≥ Loading...", 900);

  try{
    const w = await getWikipediaStory();
    const key = w.title + "::" + w.extract.slice(0, 80);
    if(!isRepeat(mem.stories, key)){
      cacheAdd(mem.stories, key);
      return renderStory(w.title, w.extract, "Wikipedia");
    }
  }catch{}

  try{
    const d = await fetchJson("https://baconipsum.com/api/?type=meat-and-filler&paras=1", {timeoutMs: 6500});
    const text = clean(Array.isArray(d) ? d[0] : "");
    if(text && text.length > 60){
      const key = "bacon::" + text.slice(0, 80);
      if(!isRepeat(mem.stories, key)){
        cacheAdd(mem.stories, key);
        return renderStory("Reading practice", text, "Internet fallback");
      }
    }
  }catch{}

  for(let i=0;i<6;i++){
    const s = buildLocalStory();
    const key = "local::" + s.slice(0, 80);
    if(!isRepeat(mem.stories, key)){
      cacheAdd(mem.stories, key);
      return renderStory("Mini story", s, "Local generator");
    }
  }
  return renderStory("Mini story", buildLocalStory(), "Local generator");
}

async function generateSpeak(){
  pill(UI.spStatus, "‚è≥ Loading...", 900);

  if(UI.aiMode.value === "gemini"){
    try{
      const g = await gemini(
        "Give ONE simple English sentence for pronunciation practice.\n"+
        "Rules: CEFR A1, no idioms, no commas, max 8 words, end with a period."
      );
      const text = clean(g);
      if(text && !isRepeat(mem.speak, text)){
        cacheAdd(mem.speak, text);
        return renderSpeak(text, "Gemini");
      }
    }catch{}
  }

  try{
    const online = await getOnlinePhrase();
    if(online){
      const short = online.split(/[.!?]/)[0].trim();
      const s = (short.length > 90) ? short.slice(0, 90) : short;
      if(s && !isRepeat(mem.speak, s)){
        cacheAdd(mem.speak, s);
        return renderSpeak(s, "Internet");
      }
    }
  }catch{}

  for(let i=0;i<6;i++){
    const local = buildSpeakSentence();
    if(local && !isRepeat(mem.speak, local)){
      cacheAdd(mem.speak, local);
      return renderSpeak(local, "Local generator");
    }
  }

  return renderSpeak(buildSpeakSentence(), "Local generator");
}

/* ===================== EXERCISES ===================== */
function makeBlank(sentence){
  const words = sentence.replace(/\.$/, "").split(" ").filter(Boolean);
  let idx = Math.min(2, words.length-1);
  if(idx < 1) idx = 1;
  const correct = words[idx] || words[0];
  words[idx] = "_____";
  return {question: words.join(" "), correct};
}
function buildOptions(correct){
  const pool = ["is","are","was","were","practice","practices","study","studies","work","works","read","reads","write","writes","go","goes","speak","speaks","learn","learns"]; 
  const set = new Set([correct]);
  while(set.size < 3) set.add(rnd(pool));
  return Array.from(set).sort(()=>Math.random()-0.5);
}

async function loadExercise(){
  pill(UI.exStatus, "‚è≥ Loading...", 900);

  if(UI.aiMode.value === "gemini"){
    try{
      const g = await gemini(
        "Create ONE English sentence suitable for a fill-in-the-blank exercise.\n"+
        "Rules: CEFR A1‚ÄìA2, present simple, end with a period.\nReturn only the sentence."
      );
      const sentence = clean(g);
      if(sentence && sentence.length > 6){
        const {question, correct} = makeBlank(sentence.endsWith(".") ? sentence : (sentence+"."));
        const key = question + "::" + correct;
        if(!isRepeat(mem.exercises, key)){
          cacheAdd(mem.exercises, key);
          return renderExercise(question, buildOptions(correct), correct, "Gemini");
        }
      }
    }catch{}
  }

  try{
    const online = await getOnlinePhrase();
    if(online){
      const sentence = clean(online);
      const {question, correct} = makeBlank(sentence.endsWith(".") ? sentence : (sentence+"."));
      const key = "net::" + question;
      if(!isRepeat(mem.exercises, key)){
        cacheAdd(mem.exercises, key);
        return renderExercise(question, buildOptions(correct), correct, "Internet");
      }
    }
  }catch{}

  for(let i=0;i<8;i++){
    const sentence = buildSentence();
    const {question, correct} = makeBlank(sentence);
    const key = "local::" + question;
    if(!isRepeat(mem.exercises, key)){
      cacheAdd(mem.exercises, key);
      return renderExercise(question, buildOptions(correct), correct, "Local generator");
    }
  }

  const sentence = buildSentence();
  const {question, correct} = makeBlank(sentence);
  return renderExercise(question, buildOptions(correct), correct, "Local generator");
}

/* ===================== SPEAK EVALUATION ===================== */
function normalizeText(t){
  return clean(t).toLowerCase().replace(/[^a-z\s']/g, "").replace(/\s+/g, " ").trim();
}
function editDistance(a,b){
  a = a || ""; b = b || "";
  const m=a.length, n=b.length;
  const dp = Array.from({length:m+1}, ()=> new Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}
function simWord(w1,w2){
  if(!w1&&!w2) return 1;
  if(!w1||!w2) return 0;
  const dist = editDistance(w1,w2);
  const max = Math.max(w1.length, w2.length) || 1;
  return 1 - (dist/max);
}
function evaluatePronunciation(target, spoken){
  const t = normalizeText(target).split(" ").filter(Boolean);
  const s = normalizeText(spoken).split(" ").filter(Boolean);
  let i=0, j=0, correct=0;
  const parts=[];
  while(i<t.length){
    const tw = t[i];
    const sw = s[j] ?? "";
    const scoreHere = simWord(tw, sw);
    const scoreSkip = simWord(tw, s[j+1] ?? "");
    let best = scoreHere;
    if(scoreSkip > scoreHere){ best = scoreSkip; j += 1; }
    const ok = best >= 0.72;
    if(ok) correct++;
    parts.push({word:tw, ok});
    i++; j++;
  }
  return {parts, percent: Math.round((correct/Math.max(1,t.length))*100)};
}
function renderPronResult(spoken){
  const target = UI.spTarget.textContent;
  const {parts, percent} = evaluatePronunciation(target, spoken);
  UI.spResult.textContent = "";

  const top = document.createElement("div");
  top.style.marginBottom = "8px";
  top.append("üó£ ");
  const b = document.createElement("b");
  b.textContent = spoken;
  top.appendChild(b);

  const line = document.createElement("div");
  parts.forEach(p=>{
    const s = document.createElement("span");
    s.textContent = p.word + " ";
    s.style.fontWeight = "900";
    s.style.color = p.ok ? "#2ecc71" : "#e74c3c";
    line.appendChild(s);
  });

  const score = document.createElement("div");
  score.style.marginTop = "10px";
  score.style.fontWeight = "950";
  score.textContent = "üéØ Pronunciation: ";
  const pct = document.createElement("span");
  pct.textContent = percent + "%";
  pct.style.color = (percent>=70) ? "#2ecc71" : "#e74c3c";
  score.appendChild(pct);

  UI.spResult.appendChild(top);
  UI.spResult.appendChild(line);
  UI.spResult.appendChild(score);
}

function startSpeak(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    toast("Micr√≥fono", "SpeechRecognition no disponible. Usa modo manual.");
    return;
  }
  try{
    const rec = new SR();
    rec.lang = "en-US";
    rec.interimResults = false;
    UI.spResult.textContent = "üéôÔ∏è Listening...";
    rec.onresult = (e)=>{
      const spoken = e.results?.[0]?.[0]?.transcript ?? "";
      renderPronResult(spoken);
    };
    rec.onerror = (e)=>{
      UI.spResult.textContent = "‚ùå " + (e.error || "Error");
    };
    rec.start();
  }catch{
    toast("Micr√≥fono", "No se pudo iniciar. Usa modo manual.");
  }
}

/* ===================== CUSTOM SPEAK PHRASE ===================== */
async function useCustomSpeakPhrase(){
  const custom = clean(UI.spCustom.value);
  if(!custom){ toast("SPEAK", "Escribe una frase en ingl√©s primero."); return; }
  cacheAdd(mem.speak, custom);
  await renderSpeak(custom, "Custom");
  toast("SPEAK", "Frase personalizada cargada.", 1600);
}

/* ===================== TRANSLATOR ===================== */
async function doTranslate(){
  const input = UI.trIn.value;
  const mode = UI.trMode.value;
  pill(UI.trStatus, "‚è≥ Translating...", 1000);
  const res = await translate(input, mode);
  UI.trOut.value = res.out;
  UI.trMeta.textContent = `ES ‚áÑ EN ¬∑ ${res.used} ¬∑ ${mode.toUpperCase()}`;
  pill(UI.trStatus, "‚úÖ Done", 1200);
}

function swapTranslator(){
  const a = UI.trIn.value;
  UI.trIn.value = UI.trOut.value;
  UI.trOut.value = a;
  // swap mode if explicit
  if(UI.trMode.value === 'en-es') UI.trMode.value = 'es-en';
  else if(UI.trMode.value === 'es-en') UI.trMode.value = 'en-es';
  toast("Translator", "Swap listo.", 1400);
}

async function copyText(val){
  try{
    await navigator.clipboard.writeText(val);
    toast("Clipboard", "Copiado.", 1400);
  }catch{
    // fallback
    const ta = document.createElement('textarea');
    ta.value = val;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand('copy'); toast("Clipboard", "Copiado.", 1400);}catch{ toast("Clipboard", "No se pudo copiar.", 1800); }
    ta.remove();
  }
}

/* ===================== SETTINGS ===================== */
function loadSettings(){
  UI.geminiKey.value = safeGet(STORE.GEMINI_KEY, "");
  UI.aiMode.value = safeGet(STORE.AI_MODE, "off");
}
function saveSettings(){
  safeSet(STORE.GEMINI_KEY, UI.geminiKey.value);
  safeSet(STORE.AI_MODE, UI.aiMode.value);
  UI.globalStatus.textContent = "‚úÖ Settings saved.";
  updateAIChip();
  // Measure bottom nav to avoid covering content
  try{
    const nav = document.getElementById("bottomNav");
    if(nav){
      const setH = ()=>{
        const h = Math.ceil(nav.getBoundingClientRect().height);
        document.documentElement.style.setProperty("--navH", h+"px");
      };
      setH();
      window.addEventListener("resize", setH);
    }
  }catch{}
  toast("Settings", "Guardado correctamente.");
}

/* ===================== WIRE EVENTS ===================== */
// PHRASES
$("phPlay").addEventListener("click", ()=> tts(UI.phEn.textContent, "en", 1));
$("phSlow").addEventListener("click", ()=> tts(UI.phEn.textContent, "en", 0.65));
$("phDuo").addEventListener("click", ()=> duo(UI.phEn.textContent, UI.phEs.textContent));
$("phNew").addEventListener("click", loadPhrase);

// STORIES
$("stPlay").addEventListener("click", ()=> tts(UI.stEn.textContent, "en", 1));
$("stSlow").addEventListener("click", ()=> tts(UI.stEn.textContent, "en", 0.65));
$("stDuo").addEventListener("click", ()=> duo(UI.stEn.textContent, UI.stEs.textContent));
$("stNew").addEventListener("click", loadStory);

// SPEAK
$("spPlay").addEventListener("click", ()=> tts(UI.spTarget.textContent, "en", 1));
$("spMic").addEventListener("click", startSpeak);
$("spNew").addEventListener("click", generateSpeak);
$("spUseCustom").addEventListener("click", useCustomSpeakPhrase);
$("spEvalManual").addEventListener("click", ()=>{
  const typed = clean(UI.spManual.value);
  if(!typed){ toast("Manual", "Escribe lo que dijiste para evaluar."); return; }
  renderPronResult(typed);
});

// EXERCISES
$("exNew").addEventListener("click", loadExercise);

// TRANSLATOR
$("trGo").addEventListener("click", doTranslate);
$("trSwap").addEventListener("click", swapTranslator);
$("trClear").addEventListener("click", ()=>{ UI.trIn.value=""; UI.trOut.value=""; toast("Translator","Limpio.",1200); });
$("trCopyIn").addEventListener("click", ()=> copyText(UI.trIn.value));
$("trCopyOut").addEventListener("click", ()=> copyText(UI.trOut.value));
$("trSpeakIn").addEventListener("click", ()=>{
  const mode = UI.trMode.value;
  const text = clean(UI.trIn.value);
  if(!text) return toast("TTS","No hay texto.",1200);
  const lang = (mode === 'es-en') ? 'es' : (mode === 'en-es' ? 'en' : (detectLang(text)==='es'?'es':'en'));
  tts(text, lang, 1);
});
$("trSpeakOut").addEventListener("click", ()=>{
  const mode = UI.trMode.value;
  const text = clean(UI.trOut.value);
  if(!text) return toast("TTS","No hay texto.",1200);
  const lang = (mode === 'es-en') ? 'en' : (mode === 'en-es' ? 'es' : (detectLang(text)==='es'?'es':'en'));
  tts(text, lang, 1);
});

UI.trIn.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
    e.preventDefault();
    doTranslate();
  }
  if(e.altKey && (e.key.toLowerCase() === 's')){
    e.preventDefault();
    swapTranslator();
  }
});

// SETTINGS
$("saveGlobal").addEventListener("click", saveSettings);
$("testGemini").addEventListener("click", async ()=>{
  UI.globalStatus.textContent = "‚è≥ Testing Gemini...";
  try{
    const out = await gemini("Say hello in ONE short English sentence. End with a period.");
    UI.globalStatus.textContent = "‚úÖ Gemini OK: " + clean(out);
    toast("Gemini", "Conexi√≥n OK.");
  }catch(e){
    UI.globalStatus.textContent = "‚ùå Gemini failed: " + (e?.message || e);
    toast("Gemini", "Fall√≥. Se usar√° fallback ilimitado.");
  }
});

// Keyboard shortcuts
window.addEventListener('keydown', (e)=>{
  if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
  const k = e.key.toLowerCase();
  if(k === 'p') loadPhrase();
  if(k === 't') setTab('tab-translator');
});

/* ===================== INIT ===================== */
(async function init(){
  loadSettings();
  updateNetChip();
  updateAIChip();

  await loadPhrase();
  await loadStory();
  await generateSpeak();
  await loadExercise();

  if(!navigator.onLine){
    toast("Offline", "Sin internet: contenido ilimitado con generador local.", 2800);
  }
})();
</script>
</body>
</html>
