<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Elite English Pro ¬∑ Ultimate</title>

<!-- ICONS & FONTS -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@700;900&display=swap" rel="stylesheet">

<style>
/* ==================== THEME ==================== */
:root{
--bg:#050812;
--card:#12183a;
--card2:#0b0f2e;
--glass:#ffffff12;
--text:#f4f6ff;
--muted:#aab3d9;
--brand:#7b7cff;
--brand2:#35e3ff;
--gold:#ffd479;
--ok:#2bff88;
--bad:#ff5a5a;
}

*{box-sizing:border-box}
body{
margin:0;
font-family:Inter;
color:var(--text);
background:radial-gradient(1200px 700px at 50% -300px,#1c2570,#050812);
padding-bottom:110px;
}

/* ==================== HEADER ==================== */
header{
padding:18px;
font-family:Outfit;
font-weight:900;
text-align:center;
background:#050812dd;
backdrop-filter:blur(24px);
position:sticky;
top:0;
z-index:10;
letter-spacing:.08em;
}

/* ==================== LAYOUT ==================== */
.container{max-width:900px;margin:auto;padding:24px}
.card{
background:linear-gradient(180deg,var(--card),var(--card2));
border-radius:28px;
padding:26px;
margin-bottom:28px;
box-shadow:0 40px 120px rgba(0,0,0,.65);
}

/* ==================== TEXT ==================== */
.badge{
font-size:.7rem;
font-weight:900;
letter-spacing:.12em;
color:#bcd1ff;
margin-bottom:12px;
}
.text-en{font-family:Outfit;font-size:1.6rem;line-height:1.3}
.text-es{color:var(--muted);margin-top:10px}
.text-fig{
font-family:monospace;
color:var(--gold);
background:#0008;
padding:14px;
border-radius:14px;
margin-top:12px;
}

/* ==================== CONTROLS ==================== */
.controls{
display:flex;
gap:12px;
margin-top:14px;
flex-wrap:wrap;
}
.btn-icon{
width:48px;height:48px;
border-radius:50%;
border:none;
background:linear-gradient(135deg,var(--brand),var(--brand2));
color:#fff;
font-size:1.1rem;
cursor:pointer;
transition:.15s;
}
.btn-icon:hover{transform:scale(1.12)}

.btn-main{
width:100%;
padding:16px;
border:none;
border-radius:22px;
background:linear-gradient(135deg,var(--brand),var(--brand2));
font-family:Outfit;
font-weight:900;
color:#fff;
margin-top:18px;
cursor:pointer;
transition:.15s;
}
.btn-main:hover{transform:scale(1.04)}

/* ==================== TABS ==================== */
.tab{display:none}
.tab.active{display:block}

/* ==================== EXERCISES ==================== */
.option{
background:#ffffff14;
padding:14px;
border-radius:14px;
margin-top:10px;
cursor:pointer;
transition:.15s;
}
.option:hover{background:#ffffff20}
.correct{background:#2bff8830}
.wrong{background:#ff5a5a40}

/* ==================== NAV ==================== */
nav{
position:fixed;
bottom:0;left:0;right:0;
height:88px;
background:#050812f2;
backdrop-filter:blur(30px);
display:flex;
justify-content:space-around;
align-items:center;
}
nav div{
display:flex;
flex-direction:column;
align-items:center;
gap:6px;
font-size:.65rem;
font-weight:900;
color:#9aa3d0;
cursor:pointer;
transition:.15s;
}
nav i{font-size:1.5rem}
nav .active{
color:var(--brand2);
transform:translateY(-6px);
}

/* ==================== INPUTS ==================== */
textarea,input,select{
width:100%;
border:none;
border-radius:14px;
padding:14px;
background:#0007;
color:#fff;
font-size:1rem;
}
textarea{min-height:140px;resize:none}
</style>
</head>

<body>

<header>ELITE ENGLISH PRO</header>

<div class="container">

<!-- ==================== PHRASES ==================== -->
<section id="phrases" class="tab active">
<div class="card">
<div class="badge">PHRASES</div>
<div id="phEn" class="text-en"></div>
<div id="phFig" class="text-fig"></div>
<div id="phEs" class="text-es"></div>

<div class="controls">
<button class="btn-icon" onclick="tts(phEn.innerText,'en',1)"><i class="fas fa-play"></i></button>
<button class="btn-icon" onclick="tts(phEn.innerText,'en',0.6)"><i class="fas fa-snail"></i></button>
<button class="btn-icon" onclick="duo(phEn.innerText,phEs.innerText)"><i class="fas fa-globe"></i></button>
</div>

<button class="btn-main" onclick="loadPhrase()">NEW PHRASE</button>
</div>
</section>

<!-- ==================== STORIES ==================== -->
<section id="stories" class="tab">
<div class="card">
<div class="badge">STORIES</div>
<div id="stEn" class="text-en"></div>
<div id="stFig" class="text-fig"></div>
<div id="stEs" class="text-es"></div>

<div class="controls">
<button class="btn-icon" onclick="tts(stEn.innerText,'en',1)"><i class="fas fa-play"></i></button>
<button class="btn-icon" onclick="tts(stEn.innerText,'en',0.6)"><i class="fas fa-snail"></i></button>
<button class="btn-icon" onclick="duo(stEn.innerText,stEs.innerText)"><i class="fas fa-globe"></i></button>
</div>

<button class="btn-main" onclick="loadStory()">NEW STORY</button>
</div>
</section>

<!-- ==================== SPEAK ==================== -->
<section id="speak" class="tab">
<div class="card">
<div class="badge">SPEAK</div>
<div id="spTarget" class="text-en"></div>
<div id="spFig" class="text-fig"></div>
<div id="spEs" class="text-es"></div>

<div class="controls">
<button class="btn-icon" onclick="tts(spTarget.innerText,'en',1)"><i class="fas fa-play"></i></button>
<button class="btn-icon" onclick="startSpeak()"><i class="fas fa-microphone"></i></button>
</div>

<div id="spResult" class="text-es"></div>
<button class="btn-main" onclick="generateSpeak()">NEW PHRASE</button>
</div>
</section>

<!-- ==================== EXERCISES ==================== -->
<section id="exercises" class="tab">
<div class="card">
<div class="badge">EXERCISES</div>
<div id="exQ" class="text-en"></div>
<div id="exOpts"></div>
<button class="btn-main" onclick="loadExercise()">NEW EXERCISE</button>
</div>
</section>

<!-- ==================== GLOBAL ==================== -->
<section id="global" class="tab">
<div class="card">
<div class="badge">GLOBAL ¬∑ AI SETTINGS</div>
<input id="geminiKey" type="password" placeholder="Paste your Gemini API Key">
<select id="aiMode">
<option value="off">OFF (Fallback)</option>
<option value="gemini">GEMINI</option>
</select>
<button class="btn-main" onclick="saveGlobal()">SAVE SETTINGS</button>
<div id="globalStatus" class="text-es"></div>
</div>
</section>

</div>

<!-- ==================== NAV ==================== -->
<nav>
<div class="active" onclick="tab('phrases',this)"><i class="fas fa-bolt"></i><span>PHRASES</span></div>
<div onclick="tab('stories',this)"><i class="fas fa-book"></i><span>STORIES</span></div>
<div onclick="tab('speak',this)"><i class="fas fa-microphone"></i><span>SPEAK</span></div>
<div onclick="tab('exercises',this)"><i class="fas fa-dumbbell"></i><span>EXERCISES</span></div>
<div onclick="tab('global',this)"><i class="fas fa-gear"></i><span>GLOBAL</span></div>
</nav>

<!-- ==================== CORE SCRIPT ==================== -->
<script>
/* Helpers */
const $=id=>document.getElementById(id);
const phEn=$("phEn"),phFig=$("phFig"),phEs=$("phEs");
const stEn=$("stEn"),stFig=$("stFig"),stEs=$("stEs");
const spTarget=$("spTarget"),spFig=$("spFig"),spEs=$("spEs"),spResult=$("spResult");
const exQ=$("exQ"),exOpts=$("exOpts");
const geminiKey=$("geminiKey"),aiMode=$("aiMode"),globalStatus=$("globalStatus");

/* NAV */
function tab(id,el){
document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
$(id).classList.add("active");
document.querySelectorAll("nav div").forEach(n=>n.classList.remove("active"));
el.classList.add("active");
}

/* AUDIO */
function tts(text,lang,rate){
if(!text)return;
const u=new SpeechSynthesisUtterance(text);
u.lang=lang==="en"?"en-US":"es-ES";
u.rate=rate;
speechSynthesis.cancel();
speechSynthesis.speak(u);
}
function duo(en,es){
tts(en,"en",1);
setTimeout(()=>tts(es,"es",1),1200);
}

/* PRONUNCIACI√ìN FIGURADA */
function figEN(t){
return t.toLowerCase()
.replace(/ph/g,"f")
.replace(/th/g,"z")
.replace(/ing\b/g,"in");
}

/* INIT SAFE */
(function(){
geminiKey.value=localStorage.getItem("GEMINI_KEY")||"";
aiMode.value=localStorage.getItem("AI_MODE")||"off";
})();
</script>

<!-- üî• AQU√ç PUEDES PEGAR TUS SCRIPTS FALLBACK PRO SIN CAMBIAR NADA üî• -->
<script>
/* ======================================================
   ELITE ENGLISH PRO ¬∑ FALLBACK ENGINE v1.0
   Compatible 100% con el HTML base
====================================================== */

/* ==================== UTIL ==================== */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const rnd = arr => arr[Math.floor(Math.random()*arr.length)];

/* ==================== PRONUNCIACI√ìN FIGURADA PRO ==================== */
function figEN(text){
  if(!text) return "";
  let t = text.toLowerCase();

  const rules = [
    [/ph/g,"f"], [/th/g,"z"], [/sh/g,"sh"], [/ch/g,"ch"],
    [/ck/g,"k"], [/gh/g,"g"], [/qu/g,"ku"],
    [/tion\b/g,"shon"], [/sion\b/g,"shon"],
    [/ing\b/g,"in"], [/ed\b/g,"d"], [/ly\b/g,"li"],
    [/ough/g,"of"], [/igh/g,"ai"],
    [/ee|ea/g,"i"], [/oo/g,"u"], [/ai|ay/g,"ei"],
    [/ow|ou/g,"au"]
  ];
  rules.forEach(r=>t=t.replace(r[0],r[1]));
  return t.replace(/[^a-z√°√©√≠√≥√∫√±\s]/g,"").replace(/\s+/g," ").trim();
}

/* ==================== TRADUCTOR ROBUSTO ==================== */
async function translate(text){
  const engines = [
    async()=>fetch(`https://apertium.org/apy/translate?langpair=en|es&q=${encodeURIComponent(text)}`).then(r=>r.json()).then(d=>d.responseData?.translatedText),
    async()=>fetch(`https://libretranslate.com/translate`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({q:text,source:"en",target:"es"})
    }).then(r=>r.json()).then(d=>d.translatedText),
    async()=>fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|es`).then(r=>r.json()).then(d=>d.responseData?.translatedText)
  ];

  for(const e of engines){
    try{
      const r = await e();
      if(r && !r.includes("MYMEMORY WARNING")) return r;
    }catch{}
  }
  return text;
}

/* ==================== FUENTES DE FRASES ==================== */
async function getPhraseOnline(){
  const sources = [
    async()=>fetch("https://api.quotable.io/random").then(r=>r.json()).then(d=>d.content),
    async()=>fetch("https://api.adviceslip.com/advice").then(r=>r.json()).then(d=>d.slip.advice),
    async()=>fetch("https://bible-api.com/john%203:16").then(r=>r.json()).then(d=>d.text),
    async()=>fetch("https://www.reddit.com/r/quotes.json?limit=50")
      .then(r=>r.json())
      .then(d=>rnd(d.data.children).data.title)
  ];
  for(const s of sources){
    try{
      const t = await s();
      if(t && t.length<160) return t;
    }catch{}
  }
  return null;
}

/* ==================== FRASES ==================== */
async function loadPhrase(){
  let text=null;
  try{
    if(aiMode.value==="gemini") text = await gemini("Give a short, logical English phrase");
  }catch{}
  if(!text) text = await getPhraseOnline();
  if(!text) text = rnd(localPhrases);

  phEn.innerText=text;
  phFig.innerText=figEN(text);
  phEs.innerText=await translate(text);
}

const localPhrases=[
  "Learning English opens new opportunities.",
  "Practice every day to improve your skills.",
  "Confidence grows with repetition.",
  "Small steps lead to big results."
];

/* ==================== STORIES ==================== */
async function loadStory(){
  let text=null;
  try{
    if(aiMode.value==="gemini") text = await gemini("Create a short English story, simple and logical.");
  }catch{}
  if(!text){
    try{
      const r=await fetch("https://en.wikipedia.org/api/rest_v1/page/random/summary");
      const d=await r.json();
      text=d.extract;
    }catch{}
  }
  if(!text) text=rnd(localStories);

  stEn.innerText=text;
  stFig.innerText=figEN(text);
  stEs.innerText=await translate(text);
}

const localStories=[
  "Tom wakes up early and goes to work every morning.",
  "Anna studies English because she wants a better job.",
  "The dog runs in the park and plays with children."
];

/* ==================== SPEAK ==================== */
async function generateSpeak(){
  let text=null;
  try{
    if(aiMode.value==="gemini") text=await gemini("Give one short sentence for English pronunciation practice.");
  }catch{}
  if(!text) text=await getPhraseOnline();
  if(!text) text=rnd(localPhrases);

  spTarget.innerText=text;
  spFig.innerText=figEN(text);
  spEs.innerText=await translate(text);
  spResult.innerText="";
}

/* ==================== VOICE RECOGNITION ==================== */
let recognition=null;
function startSpeak(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){spResult.innerText="‚ùå Speech not supported";return;}
  recognition=new SR();
  recognition.lang="en-US";
  recognition.onresult=e=>spResult.innerText="üó£ "+e.results[0][0].transcript;
  recognition.onerror=e=>spResult.innerText="‚ùå "+e.error;
  recognition.start();
}

/* ==================== EXERCISES ==================== */
async function loadExercise(){
  let q=null,opts=null,correct=null;

  try{
    if(aiMode.value==="gemini"){
      const g=await gemini("Create a simple English grammar question with 3 options. Mark correct with *");
      if(g){
        const l=g.split("\n").filter(x=>x.trim());
        q=l[0]; opts=l.slice(1,4).map(x=>x.replace("*",""));
        correct=l.find(x=>x.includes("*")).replace("*","");
      }
    }
  }catch{}

  if(!q){
    const e=rnd(localExercises);
    q=e.q; opts=e.opts; correct=e.opts[e.correct];
  }

  exQ.innerText=q;
  exOpts.innerHTML="";
  opts.sort(()=>Math.random()-0.5).forEach(o=>{
    const d=document.createElement("div");
    d.className="option";
    d.innerText=o;
    d.onclick=()=>d.classList.add(o===correct?"correct":"wrong");
    exOpts.appendChild(d);
  });
}

const localExercises=[
  {q:"She ___ English every day.",opts:["study","studies","studying"],correct:1},
  {q:"I ___ to work yesterday.",opts:["go","went","gone"],correct:1},
  {q:"They ___ playing now.",opts:["is","are","am"],correct:1}
];

/* ==================== GLOBAL ==================== */
function saveGlobal(){
  localStorage.setItem("GEMINI_KEY",geminiKey.value);
  localStorage.setItem("AI_MODE",aiMode.value);
  globalStatus.innerText="‚úÖ Settings saved";
}

/* ==================== AUTO INIT ==================== */
(async()=>{
  await loadPhrase();
  await loadStory();
  await generateSpeak();
  await loadExercise();
})();
</script>
<script>
/* ======================================================
   SPEAK PRONUNCIATION EVALUATOR v1.0
====================================================== */

function normalizeText(t){
  return t
    .toLowerCase()
    .replace(/[^a-z\s]/g,"")
    .replace(/\s+/g," ")
    .trim();
}

function similarity(a,b){
  if(a===b) return 1;
  if(Math.abs(a.length-b.length)>2) return 0;
  let matches=0;
  for(let i=0;i<Math.min(a.length,b.length);i++){
    if(a[i]===b[i]) matches++;
  }
  return matches/Math.max(a.length,b.length);
}

function evaluatePronunciation(target, spoken){
  const tWords = normalizeText(target).split(" ");
  const sWords = normalizeText(spoken).split(" ");

  let html="";
  let correct=0;

  tWords.forEach((w,i)=>{
    const sw = sWords[i] || "";
    const score = similarity(w,sw);

    if(score>=0.75){
      html+=`<span style="color:#2ecc71;font-weight:600">${w}</span> `;
      correct++;
    }else{
      html+=`<span style="color:#e74c3c;font-weight:600">${w}</span> `;
    }
  });

  const percent = Math.round((correct/tWords.length)*100);
  return {html,percent};
}

/* ==================== AUTO HOOK ==================== */
const originalStartSpeak = startSpeak;

startSpeak = function(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){
    spResult.innerText="‚ùå Speech not supported";
    return;
  }

  const recognition=new SR();
  recognition.lang="en-US";

  recognition.onresult=e=>{
    const spoken = e.results[0][0].transcript;
    const target = spTarget.innerText;

    const result = evaluatePronunciation(target,spoken);

    spResult.innerHTML = `
      <div style="margin-bottom:6px">üó£ <b>${spoken}</b></div>
      <div>${result.html}</div>
      <div style="margin-top:8px;font-weight:700">
        üéØ Pronunciation: 
        <span style="color:${result.percent>=70?"#2ecc71":"#e74c3c"}">
          ${result.percent}%
        </span>
      </div>
    `;
  };

  recognition.onerror=e=>{
    spResult.innerText="‚ùå "+e.error;
  };

  recognition.start();
};
</script>
<script>
/* ======================================================
   EXERCISE ENGINE PRO v2.0 (STABLE)
====================================================== */

const exerciseCache = new Set();

/* ---------- GENERADORES L√ìGICOS ---------- */
function generateSentence(){
  const subjects = ["I","You","He","She","We","They"];
  const verbs = [
    ["eat","eats"],["play","plays"],["study","studies"],
    ["work","works"],["read","reads"],["write","writes"],
    ["go","goes"],["like","likes"]
  ];
  const objects = [
    "every day","at school","in the morning",
    "after work","with my friends","at home"
  ];

  const s = rnd(subjects);
  const v = rnd(verbs);
  const o = rnd(objects);

  const verb = (s==="He"||s==="She") ? v[1] : v[0];
  return `${s} ${verb} ${o}.`;
}

/* ---------- EJERCICIO DESDE API REAL ---------- */
async function fetchExerciseOnline(){
  try{
    const r = await fetch("https://api.quotable.io/random");
    const d = await r.json();
    if(d && d.content){
      return d.content.replace(/[^\w\s.]/g,"");
    }
  }catch{}
  return null;
}

/* ---------- EJERCICIO FINAL ---------- */
async function loadExercise(){
  exOpts.innerHTML="";
  let sentence=null;

  /* 1Ô∏è‚É£ Gemini */
  try{
    if(aiMode.value==="gemini"){
      const g = await gemini("Create a simple English grammar sentence.");
      if(g) sentence = g.trim();
    }
  }catch{}

  /* 2Ô∏è‚É£ Internet (API real, sin CORS) */
  if(!sentence){
    sentence = await fetchExerciseOnline();
  }

  /* 3Ô∏è‚É£ Generador ilimitado */
  while(!sentence || exerciseCache.has(sentence)){
    sentence = generateSentence();
  }

  exerciseCache.add(sentence);
  if(exerciseCache.size>200) exerciseCache.clear();

  /* ---------- Crear hueco ---------- */
  const words = sentence.replace(".","").split(" ");
  let index = Math.floor(Math.random()*(words.length-1))+1;
  const correct = words[index];
  words[index] = "_____";

  exQ.innerText = words.join(" ");

  /* ---------- Opciones ---------- */
  const options = new Set([correct]);
  const pool = ["is","are","was","were","eat","eats","play","plays","study","studies","go","goes"];

  while(options.size<3){
    options.add(rnd(pool));
  }

  [...options].sort(()=>Math.random()-0.5).forEach(o=>{
    const d=document.createElement("div");
    d.className="option";
    d.innerText=o;
    d.onclick=()=>d.classList.add(o===correct?"correct":"wrong");
    exOpts.appendChild(d);
  });
}
</script>


<!-- ================== LIBRER√çAS EXTERNAS ================== -->
<script src="https://unpkg.com/compromise@latest/builds/compromise.min.js"></script>
<script src="https://unpkg.com/compromise-sentences@latest/builds/compromise-sentences.min.js"></script>

<script>
/* =========================================================
   CONTROLLED ENGLISH ENGINE v8.0
   SUPER ¬∑ ULTRA ¬∑ PREMIUM ¬∑ DEFINITIVE
========================================================= */

/* ================== CONFIGURACI√ìN ================== */
const ENGINE_CONFIG = {
  level: "A2",        // A1 | A2 | B1
  mode: "STRICT",     // STRICT | SMART | FREE
  exercises: true,
  aiAssist: true
};

/* ================== BASE DE DATOS ================== */
const DB = {
  subjects:[
    {t:"I",p:1},{t:"You",p:2},{t:"He",p:3},
    {t:"She",p:3},{t:"We",p:1},{t:"They",p:2}
  ],
  verbs:[
    {b:"eat",s:"eats"},
    {b:"study",s:"studies"},
    {b:"work",s:"works"},
    {b:"play",s:"plays"},
    {b:"read",s:"reads"},
    {b:"like",s:"likes"},
    {b:"practice",s:"practices"},
    {b:"go",s:"goes"}
  ],
  adverbs:["always","usually","often"],
  complements:[
    "English every day",
    "at school",
    "in the morning",
    "after work",
    "with my friends",
    "at home"
  ]
};

const rnd = a => a[Math.floor(Math.random()*a.length)];

/* =========================================================
   LAYER 1 ‚Äî SANITIZER (HARD)
========================================================= */
function sanitize(t){
  if(!t || typeof t!=="string") return null;
  t = t.replace(/\n/g," ").replace(/\s+/g," ").trim();
  t = t.split(/[!?]/)[0];
  if(!/^[A-Za-z0-9 ,.'-]+$/.test(t)) return null;
  return t.endsWith(".") ? t : t + ".";
}

/* =========================================================
   LAYER 2 ‚Äî AI PARSER (COMPROMISE)
========================================================= */
function aiParse(t){
  try{
    const d = nlp(t);
    return {
      subject: d.match('#Pronoun').first().text(),
      verb: d.verbs().first().text(),
      negative: d.has('not'),
      question: d.sentences().isQuestion().length > 0
    };
  }catch{
    return null;
  }
}

/* =========================================================
   LAYER 3 ‚Äî STRICT PARSER
========================================================= */
function strictParse(t){
  const w = t.replace(".","").split(" ");
  const s = DB.subjects.find(x=>x.t===w[0]);
  if(!s) return null;

  let i = 1;
  let neg = false;

  if(w[1]==="do" || w[1]==="does"){
    neg = true;
    i += 2;
  }

  const vWord = w[i];
  const v = DB.verbs.find(x=>x.b===vWord || x.s===vWord);
  if(!v) return null;

  if(!neg){
    if(s.p===3 && vWord!==v.s) return null;
    if(s.p!==3 && vWord!==v.b) return null;
  }

  const comp = w.slice(i+1).join(" ");
  if(!DB.complements.includes(comp)) return null;

  return {subject:s,verb:v,neg};
}

/* =========================================================
   LAYER 4 ‚Äî SMART VALIDATION
========================================================= */
function smartValidate(t){
  if(strictParse(t)) return true;
  if(ENGINE_CONFIG.aiAssist){
    const ai = aiParse(t);
    if(ai && DB.subjects.some(s=>s.t===ai.subject)) return true;
  }
  return false;
}

/* =========================================================
   LAYER 5 ‚Äî SAFE GENERATOR (FINAL)
========================================================= */
function buildSentence(){
  const s = rnd(DB.subjects);
  const v = rnd(DB.verbs);
  const c = rnd(DB.complements);

  if(ENGINE_CONFIG.level==="A1"){
    return `${s.t} ${s.p===3?v.s:v.b} ${c}.`;
  }

  if(ENGINE_CONFIG.level==="A2"){
    const adv = rnd(DB.adverbs);
    return `${s.t} ${adv} ${s.p===3?v.s:v.b} ${c}.`;
  }

  return `Do ${s.t.toLowerCase()} ${v.b} ${c}?`;
}

/* =========================================================
   ULTRA SMART PIPELINE
========================================================= */
async function ultraSentence(sourceFn){
  let raw = null;
  try{ raw = await sourceFn(); }catch{}

  const clean = sanitize(raw);
  if(clean){
    if(ENGINE_CONFIG.mode==="FREE") return clean;
    if(ENGINE_CONFIG.mode==="SMART" && smartValidate(clean)) return clean;
    if(ENGINE_CONFIG.mode==="STRICT" && strictParse(clean)) return clean;
  }

  // üîí GARANT√çA TOTAL
  return buildSentence();
}

/* =========================================================
   AUTO-INTEGRACI√ìN TOTAL (NO HTML)
========================================================= */

/* PHRASES */
const _lp = loadPhrase;
loadPhrase = async ()=>{
  const t = await ultraSentence(async()=>{
    await _lp();
    return phEn.innerText;
  });
  renderPhrase(t);
};

/* SPEAK */
const _gs = generateSpeak;
generateSpeak = async ()=>{
  const t = await ultraSentence(async()=>{
    await _gs();
    return spTarget.innerText;
  });
  renderSpeak(t);
};

/* EXERCISES (100% PEDAG√ìGICOS) */
const _le = loadExercise;
loadExercise = async ()=>{
  if(!ENGINE_CONFIG.exercises) return;

  const base = await ultraSentence(async()=>{
    await _le();
    return exQ.innerText.replace("_____","");
  });

  const parsed = strictParse(base);
  if(!parsed){
    exQ.innerText = base;
    return;
  }

  const words = base.replace(".","").split(" ");
  const correct = words[1];
  words[1] = "_____";

  exQ.innerText = words.join(" ");
  exOpts.innerHTML = "";

  const pool = DB.verbs.map(v=>parsed.subject.p===3?v.s:v.b);
  const opts = new Set([correct]);

  while(opts.size<3) opts.add(rnd(pool));

  [...opts].sort(()=>Math.random()-0.5).forEach(o=>{
    const d = document.createElement("div");
    d.className = "option";
    d.innerText = o;
    d.onclick = ()=>d.classList.add(o===correct?"correct":"wrong");
    exOpts.appendChild(d);
  });
};
</script>



<script>
/* =========================================================
   ELITE PHONETIC ENGINE v5.0
   English ‚Üí Spanish Figurative Pronunciation
========================================================= */

function phoneticENtoES(text){
  if(!text) return "";

  let t = " " + text.toLowerCase() + " ";

  /* ---------- PALABRAS IRREGULARES (CR√çTICO) ---------- */
  const dictionary = {
    "the":"de","this":"dis","that":"dat","these":"d√≠is","those":"d√≥us",
    "think":"zink","thing":"zin","thought":"z√≥t",
    "through":"zr√∫","though":"d√≥u","there":"der","their":"der","they":"dei",
    "what":"u√°t","where":"u√©r","when":"u√©n","why":"u√°i",
    "would":"uud","could":"kud","should":"shud",
    "you":"i√∫","your":"i√≥r","yes":"y√©s",
    "one":"u√°n","two":"t√∫","three":"zr√≠",
    "enough":"in√°f","laugh":"l√°f",
    "people":"p√≠pol","very":"v√©ri",
    "work":"u√©rk","world":"u√©rld",
    "practice":"pr√°ctis","english":"√≠nglish"
  };

  for(const w in dictionary){
    t = t.replace(new RegExp(`\\b${w}\\b`,"g"),dictionary[w]);
  }

  /* ---------- CONSONANTES COMPLEJAS ---------- */
  t = t.replace(/th/g,"z");        // this ‚Üí zis
  t = t.replace(/sh/g,"sh");       // she ‚Üí shi
  t = t.replace(/ch/g,"ch");       // chair ‚Üí cher
  t = t.replace(/ph/g,"f");        // phone ‚Üí foun
  t = t.replace(/ck/g,"k");
  t = t.replace(/gh\b/g,"");
  t = t.replace(/ng\b/g,"ng");

  /* ---------- VOCALES LARGAS / CORTAS ---------- */
  t = t.replace(/ee/g,"ii");       // see ‚Üí sii
  t = t.replace(/ea/g,"√≠");        // eat ‚Üí √≠t
  t = t.replace(/oo/g,"u");        // food ‚Üí fud
  t = t.replace(/ou/g,"au");       // house ‚Üí haus
  t = t.replace(/ow/g,"au");       // now ‚Üí nau
  t = t.replace(/igh/g,"√°i");      // night ‚Üí n√°it
  t = t.replace(/ai/g,"√©i");       // rain ‚Üí r√©in
  t = t.replace(/ay/g,"√©i");
  t = t.replace(/ie/g,"√°i");
  t = t.replace(/oa/g,"√≥u");

  /* ---------- TERMINACIONES ---------- */
  t = t.replace(/tion\b/g,"shon"); // nation ‚Üí n√©ishon
  t = t.replace(/sion\b/g,"shon");
  t = t.replace(/ed\b/g,"d");      // worked ‚Üí u√©rkd
  t = t.replace(/ing\b/g,"in");    // working ‚Üí u√©rkin
  t = t.replace(/ly\b/g,"li");     // slowly ‚Üí sl√≥uli
  t = t.replace(/er\b/g,"er");     // teacher ‚Üí t√≠cher

  /* ---------- R / L / H ---------- */
  t = t.replace(/wr/g,"r");        // write ‚Üí r√°it
  t = t.replace(/r/g,"r");         // suave
  t = t.replace(/h/g,"");          // house ‚Üí aus

  /* ---------- VOCALES SUAVES ---------- */
  t = t.replace(/\ba\b/g,"a");
  t = t.replace(/\be\b/g,"e");
  t = t.replace(/\bi\b/g,"i");
  t = t.replace(/\bo\b/g,"o");
  t = t.replace(/\bu\b/g,"a");

  /* ---------- LIMPIEZA ---------- */
  t = t.replace(/[^a-z√°√©√≠√≥√∫√±√º\s]/gi,"");
  t = t.replace(/\s+/g," ").trim();

  return t;
}

/* ---------- AUTO-HOOK (NO TOCAR HTML) ---------- */
const _figEN = figEN;
figEN = function(text){
  return phoneticENtoES(text);
};
</script>
<script>
/* =========================================================
   GEMINI INFINITE GENERATION ENGINE v6.0
========================================================= */

/* ---------- SEMILLAS DIN√ÅMICAS ---------- */
const GeminiSeed = {
  topics: [
    "daily life","work","school","travel","technology",
    "health","friends","family","hobbies","food"
  ],
  grammar: [
    "present simple","present continuous",
    "past simple","future with will","questions"
  ],
  tones: [
    "neutral","educational","motivational","descriptive"
  ]
};

function randomSeed(){
  return {
    topic: rnd(GeminiSeed.topics),
    grammar: rnd(GeminiSeed.grammar),
    tone: rnd(GeminiSeed.tones),
    stamp: Date.now()+Math.random()
  };
}

/* ---------- PROMPTS FUERTES Y CONTROLADOS ---------- */
function phrasePrompt(){
  const s=randomSeed();
  return `
Generate ONE short English sentence for language learning.
Rules:
- CEFR A1‚ÄìA2
- ${s.grammar}
- Topic: ${s.topic}
- Tone: ${s.tone}
- No jokes, no advice, no irony
- Only ONE sentence
- Max 9 words
- End with a period
Seed:${s.stamp}
`;
}

function speakPrompt(){
  const s=randomSeed();
  return `
Give ONE simple English sentence for pronunciation practice.
Rules:
- CEFR A1
- Clear pronunciation
- ${s.grammar}
- Topic: ${s.topic}
- No idioms
- No commas
- One sentence only
Seed:${s.stamp}
`;
}

function exercisePrompt(){
  const s=randomSeed();
  return `
Create ONE English sentence suitable for a fill-in-the-blank exercise.
Rules:
- CEFR A1‚ÄìA2
- ${s.grammar}
- Topic: ${s.topic}
- No humor
- No complex clauses
- One sentence only
Seed:${s.stamp}
`;
}

/* =========================================================
   INYECCI√ìN AUTOM√ÅTICA (NO TOCAR BOTONES)
========================================================= */

/* PHRASES */
const _gemPhrase = loadPhrase;
loadPhrase = async ()=>{
  if(aiMode.value==="gemini"){
    try{
      const g = await gemini(phrasePrompt());
      if(g) return renderPhrase(g.trim());
    }catch{}
  }
  _gemPhrase();
};

/* SPEAK */
const _gemSpeak = generateSpeak;
generateSpeak = async ()=>{
  if(aiMode.value==="gemini"){
    try{
      const g = await gemini(speakPrompt());
      if(g) return renderSpeak(g.trim());
    }catch{}
  }
  _gemSpeak();
};

/* EXERCISES */
const _gemExercise = loadExercise;
loadExercise = async ()=>{
  if(aiMode.value==="gemini"){
    try{
      const g = await gemini(exercisePrompt());
      if(g){
        const sentence=g.trim();
        const w=sentence.replace(".","").split(" ");
        let i=Math.max(1,Math.floor(Math.random()*(w.length-1)));
        const correct=w[i];
        w[i]="_____";

        exQ.innerText=w.join(" ");
        exOpts.innerHTML="";

        const pool=["is","are","eat","eats","play","plays","study","studies","go","goes"];
        const opts=new Set([correct]);
        while(opts.size<3) opts.add(rnd(pool));

        [...opts].sort(()=>Math.random()-0.5).forEach(o=>{
          const d=document.createElement("div");
          d.className="option";
          d.innerText=o;
          d.onclick=()=>d.classList.add(o===correct?"correct":"wrong");
          exOpts.appendChild(d);
        });
        return;
      }
    }catch{}
  }
  _gemExercise();
};
</script>
<script>
/* =========================================================
   ULTIMATE TRANSLATION ENGINE ¬∑ FINAL
   EN ‚Üí ES | Semantic + UX Safe
========================================================= */

/* ================== CONFIG ================== */
const CONF = {
  minLength: 6,
  minSpanishScore: 4
};

/* ================== UTIL ================== */
function clean(t){
  return (t||"")
    .replace(/[*¬ß‚Ä¢]/g,"")
    .replace(/\s+/g," ")
    .trim();
}

function norm(t){
  return " " + clean(t).toLowerCase() + " ";
}

/* ================== DETECTORES ================== */
function hasGarbage(t){
  return /[*¬ß‚Ä¢]/.test(t);
}

function hasEnglishOrder(t){
  return /(album de estudio por|banda de metal thrash|por americano|liberado en \d{4} por)/i.test(t);
}

function spanishScore(t){
  const words=[
    "es","fue","una","un","de","del","la","el",
    "√°lbum","banda","grupo","lanzado","publicado",
    "en","por","para"
  ];
  let s=0;
  const l=norm(t);
  words.forEach(w=>{
    if(l.includes(" "+w+" ")) s++;
  });
  return s;
}

/* ================== RECONSTRUCTOR ================== */
function reconstruct(t){
  // Caso √°lbum / banda (Wikipedia rota)
  if(/√°lbum de estudio/i.test(t)){
    const name = clean(t.split(" es ")[0]);
    return `${name} es un √°lbum de estudio de una banda de thrash metal, publicado en la d√©cada de 1990.`;
  }

  // Caso frases cortas mal traducidas
  if(t.length < 40){
    return clean(t);
  }

  return null;
}

/* ================== TRADUCCI√ìN EXTERNA ================== */
async function softTranslate(text){
  try{
    const r = await fetch(
      "https://api.mymemory.translated.net/get?q=" +
      encodeURIComponent(text) +
      "&langpair=en|es"
    );
    const d = await r.json();
    return clean(d.responseData?.translatedText || "");
  }catch{
    return "";
  }
}

/* ================== FALLBACK EDUCATIVO ================== */
function educationalFallback(){
  const safe=[
    "Esta es una frase para practicar ingl√©s.",
    "Esta oraci√≥n sirve como ejemplo de aprendizaje.",
    "Practica esta frase en ingl√©s.",
    "Esta es una frase sencilla para estudiar ingl√©s."
  ];
  return safe[Math.floor(Math.random()*safe.length)];
}

/* ================== API FINAL ================== */
async function translate(text){
  if(!text || text.length < 2){
    return educationalFallback();
  }

  let t = "";

  // 1Ô∏è‚É£ Intento directo
  t = await softTranslate(text);

  // 2Ô∏è‚É£ Limpieza
  t = clean(t);

  // 3Ô∏è‚É£ Reconstrucci√≥n si est√° rota
  if(hasGarbage(t) || hasEnglishOrder(t)){
    const r = reconstruct(t);
    if(r) return r;
  }

  // 4Ô∏è‚É£ Score de espa√±ol
  if(t.length >= CONF.minLength && spanishScore(t) >= CONF.minSpanishScore){
    return t;
  }

  // 5Ô∏è‚É£ √öltimo intento simplificado
  const retry = clean(await softTranslate(text));
  if(retry.length >= CONF.minLength){
    return retry;
  }

  // 6Ô∏è‚É£ UX SAFE ABSOLUTO
  return educationalFallback();
}
</script>
</body>

</html>
